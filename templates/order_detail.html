{% extends "base.html" %}

{% block page_title %}Order #{{ order.id }}{% endblock %}

{% block content %}
<div class="mb-4">
  <h3>Order Information</h3>
  {% if session.is_staff %}
    <form id="editOrderForm" method="POST" action="{{ url_for('edit_order', order_id=order.id) }}">
      <table class="table table-bordered">
        <tr>
          <th>Order ID</th>
          <td>{{ order.id }}</td>
        </tr>
        <tr>
          <th>Customer</th>
          <td>{{ order.customer_name }}</td>
        </tr>
        <tr>
          <th>Date Created</th>
          <td>{{ order.created_at.strftime('%Y-%m-%d') if order.created_at else 'N/A' }}</td>
        </tr>
        <tr>
          <th>Status</th>
          <td>
            <select name="status" class="form-control" id="statusSelect">
              <option value="Not Started" {% if order.status == "Not Started" %}selected{% endif %}>Not Started</option>
              <option value="In Progress" {% if order.status == "In Progress" %}selected{% endif %}>In Progress</option>
              <option value="Completed" {% if order.status == "Completed" %}selected{% endif %}>Completed</option>
              <option value="Approved" {% if order.status == "Approved" %}selected{% endif %}>Approved</option>
            </select>
          </td>
        </tr>
        <!-- Add more editable fields as needed -->
      </table>
      <div class="d-flex gap-2">
        <button type="submit" id="saveBtn" class="btn btn-primary" style="border-radius: 4px; min-width: 120px;">Save Changes</button>
        <a href="{{ url_for('portal') }}" class="btn btn-primary" style="border-radius: 4px; min-width: 120px;">Back to Dashboard</a>
        <!-- Move the delete form/button inside the flex container for horizontal alignment -->
        <form id="deleteOrderForm" method="POST" action="{{ url_for('delete_order', order_id=order.id) }}" style="display:inline;">
          <button type="submit" class="btn btn-danger text-white" style="border-radius: 4px; min-width: 120px;" onclick="return confirm('Are you sure you want to delete this order? This action cannot be reversed.');">
            Delete Order
          </button>
        </form>
      </div>
    </form>
    <script>
      const form = document.getElementById('editOrderForm');
      const saveBtn = document.getElementById('saveBtn');
      const statusSelect = document.getElementById('statusSelect');
      let initialStatus = statusSelect.value;
      let isDirty = false;

      function setButtonState() {
        if (isDirty) {
          saveBtn.classList.remove('btn-primary', 'btn-secondary');
          saveBtn.classList.add('btn-success');
          saveBtn.disabled = false;
        } else {
          saveBtn.classList.remove('btn-success', 'btn-secondary');
          saveBtn.classList.add('btn-primary');
          saveBtn.disabled = false;
        }
      }

      statusSelect.addEventListener('change', function() {
        isDirty = statusSelect.value !== initialStatus;
        setButtonState();
      });

      form.addEventListener('submit', function(e) {
        saveBtn.disabled = true;
        saveBtn.classList.remove('btn-success', 'btn-primary');
        saveBtn.classList.add('btn-secondary');
        setTimeout(function() {
          alert("All changes have been saved");
        }, 100); // Show after submit, adjust as needed
      });

      // On page load, ensure correct button state
      setButtonState();
    </script>
  {% else %}
    <table class="table table-bordered">
      <tr>
        <th>Order ID</th>
        <td>{{ order.id }}</td>
      </tr>
      <tr>
        <th>Customer</th>
        <td>{{ order.customer_name }}</td>
      </tr>
      <tr>
        <th>Date Created</th>
        <td>{{ order.created_at.strftime('%Y-%m-%d') if order.created_at else 'N/A' }}</td>
      </tr>
      <tr>
        <th>Status</th>
        <td>{{ order.status }}</td>
      </tr>
      <!-- Add more fields as needed -->
    </table>
    <a href="{{ url_for('client_dashboard') }}" class="btn btn-primary mt-3" style="border-radius: 4px;">Back to My Orders</a>
  {% endif %}
</div>
{% endblock %}