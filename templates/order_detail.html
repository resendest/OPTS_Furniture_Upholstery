{% extends "base.html" %}

{% block content %}
  <!-- DEBUG: Show milestone data structure -->
  <div style="background: #f0f0f0; padding: 10px; margin: 10px 0; font-family: monospace;">
    <strong>DEBUG - Milestones data:</strong><br>
    {% for m in milestones %}
      Milestone: {{ m }}<br>
      milestone_id: {{ m.milestone_id }}<br>
      milestone_name: {{ m.milestone_name }}<br>
      status: {{ m.status }}<br>
      ---<br>
    {% endfor %}
  </div>

  <div class="mb-4">
    <h3>Order Information</h3>
    <table class="table table-bordered">
      <tr>
        <th>Customer</th>
        <td>{{ order.customer_name }}</td>
      </tr>
      <tr>
        <th>Email</th>
        <td>{{ order.customer_email or 'N/A' }}</td>
      </tr>
      <tr>
        <th>Phone</th>
        <td>{{ order.customer_phone or 'N/A' }}</td>
      </tr>
      <tr>
        <th>Created on</th>
        <td>{{ order.created_at.strftime('%Y-%m-%d') if order.created_at else 'N/A' }}</td>
      </tr>
      <tr>
        <th>Due by</th>
        <td>{{ order.due_date.strftime('%Y-%m-%d') if order.due_date else 'N/A' }}</td>
      </tr>
    </table>

    {% if session.is_staff %}
      <form id="editOrderForm"
            method="POST"
            action="{{ url_for('edit_order', order_id=order.id) }}">
    {% endif %}

    <h4 class="mt-4">Milestone History</h4>
    <table class="table table-bordered">
      <thead>
        <tr><th>Milestone</th><th>Status</th></tr>
      </thead>
      <tbody>
        {% for m in milestones %}
          <tr>
            <td>{{ m.milestone_name }}</td>
            <td>
              {% if session.is_staff %}
                <!-- DEBUG: Show what we're generating -->
                <div style="font-size: 10px; color: red;">
                  Field name will be: milestone_status_{{ m.milestone_id }}
                </div>
                <select name="milestone_status_{{ m.milestone_id }}"
                        class="form-select">
                  {% for option in ["Not Started","In Progress","Completed"] %}
                    <option value="{{ option }}"
                      {% if m.status == option %}selected{% endif %}>
                      {{ option }}
                    </option>
                  {% endfor %}
                </select>
              {% else %}
                {{ m.status }}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    {% if session.is_staff %}
      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary" style="min-width:120px">
          Save Changes
        </button>
        <a href="{{ url_for('portal') }}" class="btn btn-secondary" style="min-width:120px">
          Back to Dashboard
        </a>
      </div>
      </form>
    {% else %}
      <a href="{{ url_for('client_dashboard') }}" class="btn btn-primary mt-3">
        Back to My Orders
      </a>
    {% endif %}
  </div>
{% endblock %}