{% extends "base.html" %}

{% block title %}Order #{{ order_id }} Scan{% endblock %}

{% block extra_head %}
  <style>
    .table-wrapper {
      overflow-x: auto;
      margin-top: 1.5rem;
    }
    .scan-form {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 2rem;
      align-items: flex-end;
      margin-bottom: 2rem;
      background: #f8f9fa;
      padding: 1.5rem 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      max-width: 600px;
    }
    .scan-form-group {
      flex: 1 1 220px;
      min-width: 220px;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .scan-form label {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .scan-form select {
      padding: 0.5rem;
      font-size: 1rem;
      border-radius: 4px;
      border: 1px solid #ced4da;
      min-width: 220px;
      max-width: 100%;
      box-sizing: border-box;
    }
    .scan-form button {
      min-width: 120px;
      height: 42px;
      margin-top: 1.5rem;
    }
    @media (max-width: 600px) {
      .scan-form {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem 0.5rem;
      }
      .scan-form-group {
        min-width: 0;
      }
    }
    .table th, .table td {
      text-align: center;
      vertical-align: middle;
    }
  </style>
{% endblock %}

{% block content %}
  <h1 class="mb-4">Order #{{ order_id }} Milestones</h1>

  <form class="scan-form" onsubmit="submitMilestone(event)">
    <div class="scan-form-group">
      <label for="milestoneSelect">Set Milestone</label>
      <select id="milestoneSelect" required>
        <option value="" disabled selected>-- Choose milestone --</option>
        {% for m in milestones %}
          <option value="{{ m.milestone_id }}">{{ m.milestone_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="scan-form-group">
      <label for="statusSelect">Set Status</label>
      <select id="statusSelect" required>
        <option value="" disabled selected>-- Choose status --</option>
        <option value="Not Started">Not Started</option>
        <option value="In Progress">In Progress</option>
        <option value="Completed">Completed</option>
        <option value="Approved">Approved</option>
      </select>
    </div>
    <button type="submit" class="btn btn-primary" style="border-radius: 4px;">Submit</button>
  </form>

  <div class="table-wrapper">
    <table class="table table-bordered table-striped">
      <thead class="table-light">
        <tr>
          <th>Stage #</th>
          <th>Milestone</th>
          <th>Status</th>
          <th>Client Action?</th>
          <th>Approved?</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for m in milestones %}
          <tr>
            <td>{{ m.stage_number if m.stage_number is defined else loop.index }}</td>
            <td>{{ m.milestone_name }}</td>
            <td>{{ m.status or "Not Started" }}</td>
            <td>{{ "Yes" if m.is_client_action else "No" }}</td>
            <td>{{ "✓" if m.is_approved else "✗" }}</td>
            <td>
              {% if not m.is_approved %}
                <button
                  type="button"
                  class="btn btn-outline-success btn-sm"
                  onclick="updateMilestone('{{ m.milestone_id }}', '{{ m.milestone_name }}')"
                >Mark as {{ m.milestone_name }}</button>
              {% else %}
                <em>Done</em>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <script>
    function submitMilestone(event) {
      event.preventDefault();
      const milestoneId = document.getElementById('milestoneSelect').value;
      const status = document.getElementById('statusSelect').value;
      if (!milestoneId || !status) return;
      updateMilestone(milestoneId, status);
    }

    function updateMilestone(milestoneId, status) {
      fetch("/scan/{{ order_id }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ milestone_id: milestoneId, status: status })
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        window.location.reload();
      })
      .catch(function(error) {
        console.error("Error:", error);
      });
    }
  </script>
{% endblock %}