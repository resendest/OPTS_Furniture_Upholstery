{% extends "base.html" %}

{% block title %}Order #{{ order_id }} Scan{% endblock %}

{% block content %}
<div class="scan-card">
  
  <p><strong>Invoice #:</strong> {{ invoice_no }}</p>    <!-- added invoice -->

  <div class="current">
    {% set ns = namespace(current_milestone=None, current_status="Not Started") %}
    
    {# Find the actual current milestone based on status, not just is_approved #}
    {% for m in milestones %}
      {% if m.status == 'In Progress' %}
        {% set ns.current_milestone = m %}
        {% set ns.current_status = "In Progress" %}
      {% elif m.status == 'Completed' and m.is_approved %}
        {% set ns.current_milestone = m %}
        {% set ns.current_status = "Completed" %}
      {% endif %}
    {% endfor %}
    
    {# If no milestone is currently in progress, find the last completed one #}
    {% if not ns.current_milestone %}
      {% for m in milestones %}
        {% if m.is_approved %}
          {% set ns.current_milestone = m %}
          {% set ns.current_status = "Completed" %}
        {% endif %}
      {% endfor %}
    {% endif %}
    
    {# Display current status #}
    {% if ns.current_milestone %}
      Your order is in <strong>{{ ns.current_milestone.milestone_name }}</strong>
      <span class="badge bg-{{ 'warning' if ns.current_status == 'In Progress' else 'success' }}">
        {{ ns.current_status }}
      </span>
    {% else %}
      Your order has <strong>not started</strong>
    {% endif %}
    
    {# Check if all milestones are completed #}
    {% set all_complete = true %}
    {% for m in milestones %}
      {% if not m.is_approved %}
        {% set all_complete = false %}
      {% endif %}
    {% endfor %}
    
    {% if all_complete %}
      <div class="text-success mt-2">
        <strong> All milestones completed!</strong>
      </div>
    {% endif %}
  </div>

  {% if ns.next_milestone %}
    <form id="milestoneForm" onsubmit="submitMilestone(event)">
      <div class="mb-3">
        <label for="milestoneSelect" class="form-label">Choose next milestone:</label>
        <select id="milestoneSelect" class="form-select" required>
          <option value="" disabled selected>-- Select milestone --</option>
          {% for m in milestones %}
            {% if not m.is_approved %}
              <option value="{{ m.milestone_id }}">
                {{ m.milestone_name }} 
                <span class="text-muted">({{ m.status }})</span>
              </option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Submit</button>
    </form>
    <div id="confirmation" class="alert alert-success d-none">Milestone updated!</div>
  {% endif %}
</div>

<script>
function submitMilestone(event) {
  event.preventDefault();
  const milestoneId = document.getElementById('milestoneSelect').value;
  if (!milestoneId) return;
  fetch("{{ url_for('shop.scan_update', order_id=order_id) }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ milestone_id: milestoneId })
  })
  .then(r => r.json().then(b => ({ status: r.status, body: b })))
  .then(({ status, body }) => {
    if (status === 201 && body.message === "OK") {
      document.getElementById('confirmation').classList.remove('d-none');
      setTimeout(() => window.location.reload(), 1200);
    } else {
      alert(body.error || "Error updating milestone.");
    }
  })
  .catch(() => {
    alert("Network or server error.");
  });
}
</script>
{% endblock %}