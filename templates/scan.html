{% extends "base.html" %}

{% block title %}Order #{{ order_id }} Scan{% endblock %}

{% block content %}
<div class="scan-card">
  
  <p><strong>Invoice #:</strong> {{ invoice_no }}</p>    <!-- added invoice -->

  <div class="current">
    {% set ns = namespace(next_milestone=None) %}
    {% for m in milestones %}
      {% if not m.is_approved and not ns.next_milestone %}
        {% set ns.next_milestone = m %}
      {% endif %}
    {% endfor %}
    {% if ns.next_milestone %}
      {% set idx = milestones.index(ns.next_milestone) %}
      {% if idx > 0 %}
        {% set current = milestones[idx-1] %}
        Your order is in <strong>{{ current.milestone_name }}</strong>
      {% else %}
        Your order has <strong>not started</strong>
      {% endif %}
    {% else %}
      <span class="text-success">All milestones completed!</span>
    {% endif %}
  </div>

  {% if ns.next_milestone %}
    <form id="milestoneForm" onsubmit="submitMilestone(event)">
      <div class="mb-3">
        <label for="milestoneSelect" class="form-label">Choose next milestone:</label>
        <select id="milestoneSelect" class="form-select" required>
          <option value="" disabled selected>-- Select milestone --</option>
          {% for m in milestones %}
            {% if not m.is_approved %}
              <option value="{{ m.milestone_id }}">{{ m.milestone_name }}</option>
            {% endif %}
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Submit</button>
    </form>
    <div id="confirmation" class="alert alert-success d-none">Milestone updated!</div>
  {% endif %}
</div>

<script>
function submitMilestone(event) {
  event.preventDefault();
  const milestoneId = document.getElementById('milestoneSelect').value;
  if (!milestoneId) return;
  fetch("{{ url_for('shop.scan_update', order_id=order_id) }}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ milestone_id: milestoneId })
  })
  .then(r => r.json().then(b => ({ status: r.status, body: b })))
  .then(({ status, body }) => {
    if (status === 201 && body.message === "OK") {
      document.getElementById('confirmation').classList.remove('d-none');
      setTimeout(() => window.location.reload(), 1200);
    } else {
      alert(body.error || "Error updating milestone.");
    }
  })
  .catch(() => {
    alert("Network or server error.");
  });
}
</script>
{% endblock %}