{% extends "base.html" %}

{% block content %}
  <h1>Order #{{ order_id }} Milestones</h1>
  <table style="width:100%; border-collapse: collapse;">
    <thead>
      <tr>
        <th style="border-bottom:1px solid #ddd; padding: 8px; text-align: center;">Stage #</th>
        <th style="border-bottom:1px solid #ddd; padding: 8px; text-align: left;">Milestone</th>
        <th style="border-bottom:1px solid #ddd; padding: 8px; text-align: center;">Client Action?</th>
        <th style="border-bottom:1px solid #ddd; padding: 8px; text-align: center;">Approved?</th>
        <th style="border-bottom:1px solid #ddd; padding: 8px; text-align: center;">Action</th>
      </tr>
    </thead>
    <tbody>
      {% for m in milestones %}
        <tr>
          <td style="border-bottom:1px solid #ddd; padding: 8px; text-align: center;">{{ m.stage_number }}</td>
          <td style="border-bottom:1px solid #ddd; padding: 8px; text-align: left;">{{ m.milestone_name }}</td>
          <td style="border-bottom:1px solid #ddd; padding: 8px; text-align: center;">{{ "Yes" if m.is_client_action else "No" }}</td>
          <td style="border-bottom:1px solid #ddd; padding: 8px; text-align: center;">{{ "✓" if m.is_approved else "✗" }}</td>
          <td style="border-bottom:1px solid #ddd; padding: 8px; text-align: center;">
            {% if not m.is_approved %}
              <button
                type="button"
                onclick="updateMilestone('{{ m.milestone_id }}', 'Started')"
                style="margin-right: 0.5rem; padding: 4px 8px;"
              >Start</button>
              <button
                type="button"
                onclick="updateMilestone('{{ m.milestone_id }}', 'Completed')"
                style="padding: 4px 8px;"
              >Complete</button>
            {% else %}
              <em>Done</em>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    function updateMilestone(milestoneId, status) {
      fetch("/scan/{{ order_id }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ milestone_id: milestoneId, status: status })
      })
      .then(function(response) {
        return response.json();
      })
      .then(function(data) {
        console.log("Update response:", data);
        window.location.reload();
      })
      .catch(function(error) {
        console.error("Error:", error);
      });
    }
  </script>
{% endblock %}
