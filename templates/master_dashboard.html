{% extends "base.html" %}
{% block title %}Master Dashboard{% endblock %}
{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' if category == 'success' else 'info' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="container py-4">
  <div class="mb-3">
    <input
      type="text"
      id="orderSearch"
      class="form-control"
      placeholder="Search orders by any fieldâ€¦"
      onkeyup="filterOrders()"
      style="max-width: 350px;"
    />
  </div>

  <!-- Filter dropdowns -->
  <div class="row mb-3">
    <div class="col">
      <select id="customerFilter" class="form-select" onchange="filterOrders()">
        <option value="">All Customers</option>
        {% for name in orders | map(attribute='customer_name') | unique | sort %}
          <option value="{{ name }}">{{ name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col">
      <select id="statusFilter" class="form-select" onchange="filterOrders()">
        <option value="">All Statuses</option>
        {% for status in orders
                    | map(attribute='computed_status')
                    | unique
                    | sort %}
          <option value="{{ status }}">{{ status }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col">
      <select id="dueDateFilter" class="form-select" onchange="filterOrders()">
        <option value="">All Due Dates</option>
        {% for due in orders | map(attribute='due_date') | unique | sort %}
          {% if due %}
          <option value="{{ due }}">{{ due }}</option>
          {% endif %}
        {% endfor %}
      </select>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped align-middle mb-0" id="ordersTable">
          <thead>
            <tr>
              <th>Invoice #</th>
              <th>Customer</th>
              <th>Due Date</th>
              <th>Status</th>
              <th>Lousso PDF</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {% for o in orders %}
            <tr>
              <td>{{ o.invoice_no }}</td>
              <td>{{ o.customer_name or '' }}</td>
              <td>{{ o.due_date }}</td>
              <td>{{ o.computed_status or 'Not Started' }}</td>
              <td>
                {% if o.lousso_pdf_path %}
                  <a href="{{ o.lousso_pdf_path }}" target="_blank">PDF</a>
                {% else %}
                  <span class="text-muted">N/A</span>
                {% endif %}
              </td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <a href="{{ url_for('view_order', order_id=o.order_id) }}" class="btn btn-outline-primary btn-sm rounded-pill">View Details</a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  function filterOrders() {
    const searchInput = document.getElementById('orderSearch').value.toLowerCase();
    const customerVal  = document.getElementById('customerFilter').value;
    const statusVal    = document.getElementById('statusFilter').value;
    const dueDateVal   = document.getElementById('dueDateFilter').value;
    const table        = document.getElementById('ordersTable');
    const trs          = table.getElementsByTagName('tr');
    
    for (let i = 1; i < trs.length; i++) {
      const tds = trs[i].getElementsByTagName('td');
      let show  = true;

      // Search filter - search all columns
      if (searchInput) {
        let found = false;
        for (let j = 0; j < tds.length; j++) {
          if (tds[j].textContent.toLowerCase().indexOf(searchInput) > -1) {
            found = true;
            break;
          }
        }
        if (!found) show = false;
      }

      // Customer filter - column 1 (0-indexed)
      if (customerVal && tds[1].textContent.trim() !== customerVal) show = false;

      // Status filter - column 3 (0-indexed)
      if (statusVal && tds[3].textContent.trim() !== statusVal) show = false;

      // Due date filter - column 2 (0-indexed)
      if (dueDateVal && tds[2].textContent.trim() !== dueDateVal) show = false;

      trs[i].style.display = show ? '' : 'none';
    }
  }
  </script>
</div>
{% endblock %}
